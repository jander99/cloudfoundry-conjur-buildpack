#!/bin/bash -e
# bin/supply <build-dir> <cache-dir> <deps-dir> <index>

# The build directory for the app.
BUILD_DIR=$1

# To store assets needed during build (currently unused).
CACHE_DIR=$2

# App dependencies are stored in $DEPS_DIR/$INDEX_DIR.
DEPS_DIR=$3
INDEX_DIR=$4

BIN_DIR=$(cd $(dirname $0); pwd)
BUILDPACK_DIR=$(dirname $BIN_DIR)

echo "[cyberark-conjur-buildpack]: supplying"


echo "[cyberark-conjur-buildpack]: looking for secrets.yml"

if [ -f $BUILD_DIR/secrets.yml ]; then
  echo " - secrets.yml file found in $BUILD_DIR"
elif  [ -f $BUILD_DIR/BOOT-INF/classes/secrets.yml ]; then
  echo " - secrets.yml file found in $BUILD_DIR/BOOT-INF/classes/secrets.yml copy to $BUILD_DIR"
  cp $BUILD_DIR/BOOT-INF/classes/secrets.yml $BUILD_DIR/secrets.yml
else
  echo " - Unable to find a secrets.yml... exit"
  exit 1
fi

echo "[cyberark-conjur-buildpack]: looking for cyberark-conjur in VCAP_SERVICES"
if [[ false = $(echo $VCAP_SERVICES | jq 'has("cyberark-conjur")') ]]; then
  echo "No credentials for cyberark-conjur service found in VCAP_SERVICES."
  exit 1
else
  echo " - found it"
fi

echo "[cyberark-conjur-buildpack]: download go"
source "$BUILDPACK_DIR/scripts/install_go.sh"


pushd  ${DEPS_DIR}/${INDEX_DIR}
  cd ${BUILDPACK_DIR}/conjur-env

  echo "[cyberark-conjur-buildpack]: building the conjur-env binary.. download the dependencies"
  $GoInstallDir/go/bin/go mod download

  echo "[cyberark-conjur-buildpack]: building the conjur-env binary.. building the binary"
  GOOS=linux \
  GOARCH=amd64 \
  CGO_ENABLED=0 \
  $GoInstallDir/go/bin/go build -o ${BUILDPACK_DIR}/vendor/conjur-env -a -ldflags '-extldflags "-static"' .

popd

echo "[cyberark-conjur-buildpack]: setup the profile.d script so the conjur app starts automatically"


pushd ${DEPS_DIR}/${INDEX_DIR}
  # We add the lib/0001_retrieve-secrets.sh script to profile.d so that it will
  # be run automatically to retrieve secrets when the app starts.
  mkdir -p $BUILD_DIR/profile.d
  cp ${BUILDPACK_DIR}/lib/0001_retrieve-secrets.sh $BUILD_DIR/profile.d/0001_retrieve-secrets.sh
  sed "s/__BUILDPACK_INDEX__/$INDEX_DIR/g" $BUILD_DIR/profile.d/0001_retrieve-secrets.sh -i

  # conjur-env reads a secrets.yml file and uses it to retrieve secrets from
  # Conjur. We copy it to the dependency directory to make it accessible to the
  # /profile.d script. The /vendor subdirectory is just for convenience.
  mkdir -p vendor
  cp ${BUILDPACK_DIR}/vendor/conjur-env $BUILD_DIR/vendor/conjur-env
popd


